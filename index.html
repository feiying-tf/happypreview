<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js"></script>
    <style>
      .my-gallery {
        width: 100%;
        float: left;
      }
      .my-gallery img {
        width: 100%;
        height: auto;
      }
      .my-gallery figure {
        display: block;
        float: left;
        margin: 0 5px 5px 0;
        width: 150px;
      }
      .my-gallery figcaption {
        display: none;
      }
    </style>
  </head>
  <body>
    <h2>First gallery:</h2>
    <div class="my-gallery" itemscope itemtype="http://schema.org/ImageGallery">
      <figure
        itemprop="associatedMedia"
        itemscope
        itemtype="http://schema.org/ImageObject"
      >
        <a
          href="https://farm3.staticflickr.com/2567/5697107145_a4c2eaa0cd_o.jpg"
          itemprop="contentUrl"
          data-size="1024x1024"
        >
          <img
            src="https://farm3.staticflickr.com/2567/5697107145_3c27ff3cd1_m.jpg"
            itemprop="thumbnail"
            alt="Image description"
          />
        </a>
        <figcaption itemprop="caption description">Image caption 1</figcaption>
      </figure>

      <figure
        itemprop="associatedMedia"
        itemscope
        itemtype="http://schema.org/ImageObject"
      >
        <a
          href="https://farm2.staticflickr.com/1043/5186867718_06b2e9e551_b.jpg"
          itemprop="contentUrl"
          data-size="964x1024"
        >
          <img
            src="https://farm2.staticflickr.com/1043/5186867718_06b2e9e551_m.jpg"
            itemprop="thumbnail"
            alt="Image description"
          />
        </a>
        <figcaption itemprop="caption description">Image caption 2</figcaption>
      </figure>

      <figure
        itemprop="associatedMedia"
        itemscope
        itemtype="http://schema.org/ImageObject"
      >
        <a
          href="https://farm7.staticflickr.com/6175/6176698785_7dee72237e_b.jpg"
          itemprop="contentUrl"
          data-size="1024x683"
        >
          <img
            src="https://farm7.staticflickr.com/6175/6176698785_7dee72237e_m.jpg"
            itemprop="thumbnail"
            alt="Image description"
          />
        </a>
        <figcaption itemprop="caption description">Image caption 3</figcaption>
      </figure>

      <figure
        itemprop="associatedMedia"
        itemscope
        itemtype="http://schema.org/ImageObject"
      >
        <a
          href="https://farm6.staticflickr.com/5023/5578283926_822e5e5791_b.jpg"
          itemprop="contentUrl"
          data-size="1024x768"
        >
          <img
            src="https://farm6.staticflickr.com/5023/5578283926_822e5e5791_m.jpg"
            itemprop="thumbnail"
            alt="Image description"
          />
        </a>
        <figcaption itemprop="caption description">Image caption 4</figcaption>
      </figure>
    </div>

    <!-- Root element of PhotoSwipe. Must have class pswp. -->
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
      <!-- Background of PhotoSwipe. 
           It's a separate element, as animating opacity is faster than rgba(). -->
      <div class="pswp__bg"></div>

      <!-- Slides wrapper with overflow:hidden. -->
      <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. PhotoSwipe keeps only 3 slides in DOM to save memory. -->
        <!-- don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
          <div class="pswp__top-bar">
            <!--  Controls are self-explanatory. Order can be changed. -->

            <div class="pswp__counter"></div>

            <button
              class="pswp__button pswp__button--close"
              title="Close (Esc)"
            ></button>

            <button
              class="pswp__button pswp__button--share"
              title="Share"
            ></button>

            <button
              class="pswp__button pswp__button--fs"
              title="Toggle fullscreen"
            ></button>

            <button
              class="pswp__button pswp__button--zoom"
              title="Zoom in/out"
            ></button>

            <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
            <!-- element will get class pswp__preloader--active when preloader is running -->
            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                  <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>

          <div
            class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"
          >
            <div class="pswp__share-tooltip"></div>
          </div>

          <button
            class="pswp__button pswp__button--arrow--left"
            title="Previous (arrow left)"
          ></button>

          <button
            class="pswp__button pswp__button--arrow--right"
            title="Next (arrow right)"
          ></button>

          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  var initPhotoSwipeFromDOM = function(gallerySelector) {
    // parse slide data (url, title, size ...) from DOM elements
    // (children of gallerySelector)
    var parseThumbnailElements = function(el) {
      var thumbElements = el.childNodes,
        numNodes = thumbElements.length,
        items = [],
        figureEl,
        linkEl,
        size,
        item;

      for (var i = 0; i < numNodes; i++) {
        figureEl = thumbElements[i]; // <figure> element

        // include only element nodes
        if (figureEl.nodeType !== 1) {
          continue;
        }

        linkEl = figureEl.children[0]; // <a> element

        size = linkEl.getAttribute("data-size").split("x"); // 获取到a标签的尺寸

        // create slide object
        item = {
          src: linkEl.getAttribute("href"), // 获取到a便签href对应的链接值，在这儿对应的是大图
          w: parseInt(size[0], 10),
          h: parseInt(size[1], 10)
        };

        if (figureEl.children.length > 1) {
          // 获取 figcaption 里面的内容作为title
          item.title = figureEl.children[1].innerHTML;
        }

        if (linkEl.children.length > 0) {
          // a 标签包裹的img标签的src
          item.msrc = linkEl.children[0].getAttribute("src");
        }
        /*
          item结构为：
          {
            src: // 大图地址
            w: // 宽度
            h: // 高度
            msrc: //img地址
            el: figure对应的dom
            title: // 
          }
        */
        item.el = figureEl; // save link to element for getThumbBoundsFn
        items.push(item);
      }

      return items;
    };

    // find nearest parent element
    var closest = function closest(el, fn) {
      return el && (fn(el) ? el : closest(el.parentNode, fn));
    };

    // 点击事件
    var onThumbnailsClick = function(e) {
      e = e || window.event;
      e.preventDefault ? e.preventDefault() : (e.returnValue = false);
      // 通过委托模式，获取被点击的那个元素
      var eTarget = e.target || e.srcElement;

      // 通过递归的方式查看被点击元素的父元素是否有figure标签，如果有就返回figure
      var clickedListItem = closest(eTarget, function(el) {
        return el.tagName && el.tagName.toUpperCase() === "FIGURE";
      });
      // 如果没有figure标签，就返回。
      if (!clickedListItem) {
        return;
      }

      var clickedGallery = clickedListItem.parentNode, // 获取 figure 标签的父元素，就是传入的gallerySelector对应的那个元素
        childNodes = clickedListItem.parentNode.childNodes, // 返回 gallerySelector 的所有子元素，在这里就是gallerySelector下面所有的figure
        numChildNodes = childNodes.length, // figure 的长度
        nodeIndex = 0, // 
        index;

      for (var i = 0; i < numChildNodes; i++) {
        if (childNodes[i].nodeType !== 1) { // 过滤掉不是标签的节点
          continue;
        }

        if (childNodes[i] === clickedListItem) {
          index = nodeIndex; // 将index赋值为被点击元素所在兄弟节点的索引
          break;
        }
        nodeIndex++;
      }

      if (index >= 0) {
        // 如果被点击的元素为有效元素
        openPhotoSwipe(index, clickedGallery);
      }
      return false;
    };

    // parse picture index and gallery index from URL (#&pid=1&gid=2)
    var photoswipeParseHash = function() {
      var hash = window.location.hash.substring(1),
        params = {};

      if (hash.length < 5) {
        return params;
      }

      var vars = hash.split("&");
      for (var i = 0; i < vars.length; i++) {
        if (!vars[i]) {
          continue;
        }
        var pair = vars[i].split("=");
        if (pair.length < 2) {
          continue;
        }
        params[pair[0]] = pair[1];
      }

      if (params.gid) {
        params.gid = parseInt(params.gid, 10);
      }

      return params;
    };

    var openPhotoSwipe = function(
      index,
      galleryElement,
      disableAnimation,
      fromURL
    ) {
      var pswpElement = document.querySelectorAll(".pswp")[0], // 获取到 .pswp 对应的元素
        gallery,
        options,
        items;
      
      // 获取到所有figure对应的内容
      /* 每个item的结构
        {
          src: // 大图地址
          w: // 宽度
          h: // 高度
          msrc: //img地址
          el: figure对应的dom
        }
      */
      items = parseThumbnailElements(galleryElement);

      // define options (if needed)
      options = {
        // define gallery index (for URL)
        galleryUID: galleryElement.getAttribute("data-pswp-uid"), // 获取外层元素的 .data-pswp-uid 属性

        getThumbBoundsFn: function(index) {
          // See Options -> getThumbBoundsFn section of documentation for more info
          var thumbnail = items[index].el.getElementsByTagName("img")[0], // find thumbnail
            pageYScroll =
              window.pageYOffset || document.documentElement.scrollTop, // 获取被卷去的高度
            rect = thumbnail.getBoundingClientRect(); // 返回缩略图的大小及其相对于视口的位置

          return { x: rect.left, y: rect.top + pageYScroll, w: rect.width };
        }
      };

      // PhotoSwipe opened from URL
      if (fromURL) { // 当 fromURL 为真的时候
        if (options.galleryPIDs) {
          // parse real index when custom PIDs are used
          // http://photoswipe.com/documentation/faq.html#custom-pid-in-url
          for (var j = 0; j < items.length; j++) {
            if (items[j].pid == index) {
              options.index = j;
              break;
            }
          }
        } else {
          // in URL indexes start from 1
          options.index = parseInt(index, 10) - 1;
        }
      } else {
        options.index = parseInt(index, 10);
      }

      // exit if index not found
      if (isNaN(options.index)) {
        return;
      }

      if (disableAnimation) { // 当disableAnimation为真
        options.showAnimationDuration = 0;
      }

      // Pass data to PhotoSwipe and initialize it
      gallery = new PhotoSwipe( // 创建一个画廊
        pswpElement, // 传入 .pswp对应的元素
        PhotoSwipeUI_Default, 
        items, // 传入items
        options // 传入options
      );
      gallery.init(); // 初始化画廊
    };

    // 获取所有的类名为 gallerySelector 的元素
    var galleryElements = document.querySelectorAll(gallerySelector);

    for (var i = 0, l = galleryElements.length; i < l; i++) {
      // 为每一个元素添加 data-pswp-uid 属性，并依次 + 1
      galleryElements[i].setAttribute("data-pswp-uid", i + 1);
      // 为每个元素添加点击事件 onThumbnailsClick
      galleryElements[i].onclick = onThumbnailsClick;
    }

    // Parse URL and open gallery if it contains #&pid=3&gid=1
    // 如果hash值上面有pid和gid，那么就显示画廊
    var hashData = photoswipeParseHash();
    if (hashData.pid && hashData.gid) {
      openPhotoSwipe(
        hashData.pid,
        galleryElements[hashData.gid - 1],
        true,
        true
      );
    }
  };

  // 运行程序，传入类名 .my-gallery
  initPhotoSwipeFromDOM(".my-gallery");
</script>
